<?xml version="1.0" encoding="UTF-8"?>
<include>
  <!-- Default dialplan for AIDevelo Voice Agent -->
  
  <!-- Extension 1000: AI Agent Demo (for test calls) -->
  <extension name="ai-agent-demo">
    <condition field="destination_number" expression="^1000$">
      <!-- Answer the call -->
      <action application="answer"/>
      
      <!-- Play greeting using FreeSWITCH TTS -->
      <action application="speak" data="flite|kal|Hallo! Sie sind mit dem Test-Agent verbunden. Bitte sprechen Sie nach dem Signal."/>
      
      <!-- Play beep -->
      <action application="playback" data="tone_stream://%(500,500,800)"/>
      
      <!-- Echo back audio (for testing - user can hear themselves) -->
      <action application="echo"/>
      
      <!-- Keep call active for 60 seconds -->
      <action application="sleep" data="60000"/>
      
      <!-- Hangup -->
      <action application="hangup"/>
    </condition>
  </extension>
  
  <!-- Extension 1001-1999: Tenant-specific extensions (mapped via location_id) -->
  <extension name="tenant-extensions">
    <condition field="destination_number" expression="^(1[0-9]{3})$">
      <!-- Extract location_id from extension mapping (would be in DB or config) -->
      <!-- For now, use extension as location_id hash -->
      <action application="set" data="location_id=ext_${destination_number}"/>
      <action application="set" data="agent_id=default"/>
      <action application="transfer" data="1000 XML default"/>
    </condition>
  </extension>
  
  <!-- Inbound calls from SIP trunk (DID routing) -->
  <extension name="inbound-did-routing">
    <condition field="destination_number" expression="^(\+?[0-9]+)$">
      <!-- Route to backend for DID -> location_id mapping -->
      <action application="set" data="did_routing_url=${did_routing_url:-http://aidevelo:5000/api/freeswitch/did-routing}"/>
      <action application="set" data="location_id=${curl(${did_routing_url}?did=${destination_number})}"/>
      
      <!-- If location_id found, route to agent -->
      <action application="transfer" data="1000 XML default" condition="${location_id(${location_id})}"/>
      
      <!-- Otherwise, play error message -->
      <action application="answer" condition="${!location_id(${location_id})}"/>
      <action application="playback" data="ivr/ivr-number_not_in_service.wav"/>
      <action application="hangup"/>
    </condition>
  </extension>
  
</include>
