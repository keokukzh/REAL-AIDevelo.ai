<?xml version="1.0" encoding="UTF-8"?>
<include>
  <!-- Default dialplan for AIDevelo Voice Agent -->
  
  <!-- Extension 1000: AI Agent Demo (for test calls) -->
  <!-- Uses own agent: ASR → LLM → TTS (NO ElevenLabs!) -->
  <extension name="ai-agent-demo">
    <condition field="destination_number" expression="^1000$">
      <!-- Extract location_id and agent_id from variables (set by caller or default) -->
      <action application="set" data="location_id=${location_id:-default}"/>
      <action application="set" data="agent_id=${agent_id:-default}"/>
      
      <!-- Answer the call -->
      <action application="answer"/>
      
      <!-- Set API hangup hook to notify backend when call ends -->
      <action application="set" data="api_hangup_hook=luarun /usr/share/freeswitch/scripts/notify_hangup.lua ${uuid} ${location_id} ${agent_id}"/>
      
      <!-- Start call session in backend via HTTP -->
      <action application="set" data="call_controller_url=${call_controller_url:-http://aidevelo:5000/api/freeswitch/call/start}"/>
      <action application="curl" data="${call_controller_url} POST location_id=${location_id}&amp;agent_id=${agent_id}&amp;call_sid=${uuid}"/>
      
      <!-- Execute call controller Lua script -->
      <!-- This script uses OWN agent: ASR → LLM → TTS -->
      <action application="lua" data="call_controller.lua ${uuid} ${location_id} ${agent_id}"/>
    </condition>
  </extension>
  
  <!-- Extension 1001-1999: Tenant-specific extensions (mapped via location_id) -->
  <extension name="tenant-extensions">
    <condition field="destination_number" expression="^(1[0-9]{3})$">
      <!-- Extract location_id from extension mapping (would be in DB or config) -->
      <!-- For now, use extension as location_id hash -->
      <action application="set" data="location_id=ext_${destination_number}"/>
      <action application="set" data="agent_id=default"/>
      <action application="transfer" data="1000 XML default"/>
    </condition>
  </extension>
  
  <!-- Inbound calls from SIP trunk (DID routing) -->
  <extension name="inbound-did-routing">
    <condition field="destination_number" expression="^(\+?[0-9]+)$">
      <!-- Route to backend for DID -> location_id mapping -->
      <action application="set" data="did_routing_url=${did_routing_url:-http://aidevelo:5000/api/freeswitch/did-routing}"/>
      <action application="set" data="location_id=${curl(${did_routing_url}?did=${destination_number})}"/>
      
      <!-- If location_id found, route to agent -->
      <action application="transfer" data="1000 XML default" condition="${location_id(${location_id})}"/>
      
      <!-- Otherwise, play error message -->
      <action application="answer" condition="${!location_id(${location_id})}"/>
      <action application="playback" data="ivr/ivr-number_not_in_service.wav"/>
      <action application="hangup"/>
    </condition>
  </extension>
  
</include>
